name: "[C2C] CI/CD Pipeline - mall-maintenance-dev"

on:
  push:
    branches:
      - main
    paths-ignore:
      - '**.md'
      - '.github/workflows/c2c-bootstrap-*.yml'
  workflow_dispatch:

env:
  APP_NAME: mall-maintenance
  TENANT: opsera
  ENVIRONMENT: dev
  NAMESPACE: opsera-mall-maintenance-dev
  AWS_REGION: us-west-2
  REGION_SHORT: usw2
  HUB_CLUSTER: argocd-usw2
  SPOKE_CLUSTER: opsera-usw2-np
  ARGOCD_SERVER: argocd-usw2.agent.opsera.dev
  ECR_REPO_NAME: opsera/mall-maintenance
  DOMAIN: agent.opsera.dev

jobs:
  build-and-deploy:
    name: "Build, Push, and Deploy"
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: write
      security-events: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GH_PAT }}

      - name: Generate unique image tag
        id: gen_tag
        run: |
          SHORT_SHA=$(echo ${{ github.sha }} | cut -c1-7)
          TIMESTAMP=$(date +%Y%m%d-%H%M%S)
          IMAGE_TAG="${SHORT_SHA}-${TIMESTAMP}"
          echo "image_tag=${IMAGE_TAG}" >> $GITHUB_OUTPUT
          echo "Generated image tag: ${IMAGE_TAG}"

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Get AWS Account ID
        id: aws_account
        run: |
          AWS_ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
          echo "account_id=${AWS_ACCOUNT_ID}" >> $GITHUB_OUTPUT
          echo "AWS Account: ${AWS_ACCOUNT_ID}"

      - name: Login to Amazon ECR
        uses: aws-actions/amazon-ecr-login@v2

      - name: Build and push Docker image
        run: |
          AWS_ACCOUNT_ID=${{ steps.aws_account.outputs.account_id }}
          ECR_URI="${AWS_ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com/${ECR_REPO_NAME}"
          IMAGE_TAG=${{ steps.gen_tag.outputs.image_tag }}

          docker build \
            --file .${TENANT}-${APP_NAME}/Dockerfile \
            --tag ${ECR_URI}:${IMAGE_TAG} \
            --build-arg BUILD_DATE=$(date -u +'%Y-%m-%dT%H:%M:%SZ') \
            --build-arg VCS_REF=${{ github.sha }} \
            .

          docker push ${ECR_URI}:${IMAGE_TAG}

          echo "ECR_URI=${ECR_URI}" >> $GITHUB_ENV
          echo "IMAGE_TAG=${IMAGE_TAG}" >> $GITHUB_ENV

      - name: Setup kubectl
        uses: azure/setup-kubectl@v3

      - name: Refresh ECR secret on SPOKE
        run: |
          AWS_ACCOUNT_ID=${{ steps.aws_account.outputs.account_id }}
          ECR_REGISTRY="${AWS_ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com"
          ECR_TOKEN=$(aws ecr get-login-password --region ${AWS_REGION})

          aws eks update-kubeconfig --name ${SPOKE_CLUSTER} --region ${AWS_REGION} --alias spoke
          kubectl config use-context spoke

          kubectl delete secret ecr-pull-secret -n ${NAMESPACE} --ignore-not-found
          kubectl create secret docker-registry ecr-pull-secret \
            --docker-server=${ECR_REGISTRY} \
            --docker-username=AWS \
            --docker-password=${ECR_TOKEN} \
            --namespace=${NAMESPACE}

      - name: Update kustomization.yaml
        run: |
          AWS_ACCOUNT_ID=${{ steps.aws_account.outputs.account_id }}
          ECR_URI="${AWS_ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com/${ECR_REPO_NAME}"
          IMAGE_TAG=${{ steps.gen_tag.outputs.image_tag }}
          OVERLAY_PATH=".${TENANT}-${APP_NAME}/k8s/overlays/${ENVIRONMENT}"

          cd ${OVERLAY_PATH}

          sed -i.bak "s|newName:.*|newName: ${ECR_URI}|g" kustomization.yaml
          sed -i.bak "s|newTag:.*|newTag: ${IMAGE_TAG}|g" kustomization.yaml
          rm -f kustomization.yaml.bak

      - name: Commit and push manifest changes
        run: |
          git config user.name "opsera-bot"
          git config user.email "bot@opsera.io"

          git pull --rebase origin main || true

          if ! git diff --quiet; then
            git add .${TENANT}-${APP_NAME}/k8s/overlays/${ENVIRONMENT}/kustomization.yaml
            git commit -m "chore: Update ${ENVIRONMENT} image to ${{ steps.gen_tag.outputs.image_tag }} [skip ci]"
            git push origin main
          fi

      - name: Create/Update ArgoCD Application
        run: |
          aws eks update-kubeconfig --name ${HUB_CLUSTER} --region ${AWS_REGION} --alias hub
          kubectl config use-context hub
          kubectl apply -f .${TENANT}-${APP_NAME}/argocd/${ENVIRONMENT}/application.yaml

      - name: Sync ArgoCD Application
        run: |
          kubectl config use-context hub
          APP_NAME_FULL="${APP_NAME}-${ENVIRONMENT}"

          kubectl patch application ${APP_NAME_FULL} -n argocd \
            --type merge \
            --patch '{"metadata":{"annotations":{"argocd.argoproj.io/refresh":"hard"}}}'

          echo "Waiting for sync..."
          sleep 30

      - name: Verify deployment
        run: |
          kubectl config use-context spoke
          kubectl wait --for=condition=available --timeout=300s \
            deployment/${APP_NAME} -n ${NAMESPACE}

          kubectl get pods -n ${NAMESPACE}

      - name: Deployment Summary
        if: always()
        run: |
          echo "### Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Application | ${APP_NAME} |" >> $GITHUB_STEP_SUMMARY
          echo "| Environment | ${ENVIRONMENT} |" >> $GITHUB_STEP_SUMMARY
          echo "| Image Tag | ${{ steps.gen_tag.outputs.image_tag }} |" >> $GITHUB_STEP_SUMMARY
          echo "| URL | https://${APP_NAME}-${ENVIRONMENT}.${DOMAIN} |" >> $GITHUB_STEP_SUMMARY
