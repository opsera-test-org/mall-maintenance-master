name: Diagnostics - mall-maintenance

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to diagnose'
        required: true
        type: choice
        options:
          - dev
        default: dev
      check_argocd:
        description: 'Check ArgoCD status'
        required: false
        type: boolean
        default: true
      check_pods:
        description: 'Check pod status'
        required: false
        type: boolean
        default: true
      check_events:
        description: 'Check recent events'
        required: false
        type: boolean
        default: true

env:
  APP_NAME: mall-maintenance
  TENANT: opsera
  AWS_REGION: us-west-2

permissions:
  contents: read
  id-token: write

jobs:
  diagnostics:
    name: Run Diagnostics - ${{ inputs.environment }}
    runs-on: ubuntu-latest
    steps:
      - name: Set Environment Variables
        run: |
          case "${{ inputs.environment }}" in
            dev)
              echo "NAMESPACE=opsera-mall-maintenance-dev" >> $GITHUB_ENV
              echo "SPOKE_CLUSTER=opsera-usw2-np" >> $GITHUB_ENV
              ;;
            *)
              echo "Unknown environment"
              exit 1
              ;;
          esac

      - name: Install kubectl
        uses: azure/setup-kubectl@v4

      - name: Setup Kubeconfig for Spoke Cluster
        run: |
          mkdir -p ~/.kube
          echo "${{ secrets.KUBECONFIG_SPOKE }}" | base64 -d > ~/.kube/config
          chmod 600 ~/.kube/config

          kubectl cluster-info
          echo "✅ Connected to spoke cluster: ${SPOKE_CLUSTER}"

      - name: Check ArgoCD Application
        if: inputs.check_argocd == true
        run: |
          echo "## ArgoCD Application Status" | tee -a $GITHUB_STEP_SUMMARY

          # Setup hub kubeconfig for ArgoCD check
          echo "${{ secrets.KUBECONFIG_HUB }}" | base64 -d > ~/.kube/config-hub
          export KUBECONFIG=~/.kube/config-hub

          APP="${APP_NAME}-${{ inputs.environment }}"

          if kubectl get application ${APP} -n argocd &>/dev/null; then
            echo "\`\`\`" | tee -a $GITHUB_STEP_SUMMARY
            kubectl get application ${APP} -n argocd -o yaml | tee -a $GITHUB_STEP_SUMMARY
            echo "\`\`\`" | tee -a $GITHUB_STEP_SUMMARY

            SYNC_STATUS=$(kubectl get application ${APP} -n argocd -o jsonpath='{.status.sync.status}')
            HEALTH_STATUS=$(kubectl get application ${APP} -n argocd -o jsonpath='{.status.health.status}')

            echo "- **Sync Status**: ${SYNC_STATUS}" | tee -a $GITHUB_STEP_SUMMARY
            echo "- **Health Status**: ${HEALTH_STATUS}" | tee -a $GITHUB_STEP_SUMMARY
          else
            echo "❌ ArgoCD application not found: ${APP}" | tee -a $GITHUB_STEP_SUMMARY
          fi

          # Restore spoke kubeconfig
          export KUBECONFIG=~/.kube/config

      - name: Check Namespace
        run: |
          echo "## Namespace Status" | tee -a $GITHUB_STEP_SUMMARY

          if kubectl get namespace ${NAMESPACE} &>/dev/null; then
            echo "✅ Namespace exists: ${NAMESPACE}" | tee -a $GITHUB_STEP_SUMMARY
          else
            echo "❌ Namespace not found: ${NAMESPACE}" | tee -a $GITHUB_STEP_SUMMARY
            exit 1
          fi

      - name: Check Deployments
        if: inputs.check_pods == true
        run: |
          echo "## Deployment Status" | tee -a $GITHUB_STEP_SUMMARY

          echo "\`\`\`" | tee -a $GITHUB_STEP_SUMMARY
          kubectl get deployment -n ${NAMESPACE} | tee -a $GITHUB_STEP_SUMMARY
          echo "\`\`\`" | tee -a $GITHUB_STEP_SUMMARY

          if kubectl get deployment ${APP_NAME} -n ${NAMESPACE} &>/dev/null; then
            echo "### Deployment Details" | tee -a $GITHUB_STEP_SUMMARY
            echo "\`\`\`yaml" | tee -a $GITHUB_STEP_SUMMARY
            kubectl describe deployment ${APP_NAME} -n ${NAMESPACE} | tee -a $GITHUB_STEP_SUMMARY
            echo "\`\`\`" | tee -a $GITHUB_STEP_SUMMARY
          fi

      - name: Check Pods
        if: inputs.check_pods == true
        run: |
          echo "## Pod Status" | tee -a $GITHUB_STEP_SUMMARY

          echo "\`\`\`" | tee -a $GITHUB_STEP_SUMMARY
          kubectl get pods -n ${NAMESPACE} -l app=${APP_NAME} -o wide | tee -a $GITHUB_STEP_SUMMARY
          echo "\`\`\`" | tee -a $GITHUB_STEP_SUMMARY

          # Get pod logs if any pod is not running
          for pod in $(kubectl get pods -n ${NAMESPACE} -l app=${APP_NAME} -o jsonpath='{.items[*].metadata.name}'); do
            POD_STATUS=$(kubectl get pod $pod -n ${NAMESPACE} -o jsonpath='{.status.phase}')

            echo "### Pod: $pod (Status: ${POD_STATUS})" | tee -a $GITHUB_STEP_SUMMARY

            if [ "${POD_STATUS}" != "Running" ]; then
              echo "#### Pod Events:" | tee -a $GITHUB_STEP_SUMMARY
              echo "\`\`\`" | tee -a $GITHUB_STEP_SUMMARY
              kubectl describe pod $pod -n ${NAMESPACE} | tail -30 | tee -a $GITHUB_STEP_SUMMARY
              echo "\`\`\`" | tee -a $GITHUB_STEP_SUMMARY

              echo "#### Pod Logs:" | tee -a $GITHUB_STEP_SUMMARY
              echo "\`\`\`" | tee -a $GITHUB_STEP_SUMMARY
              kubectl logs $pod -n ${NAMESPACE} --tail=50 | tee -a $GITHUB_STEP_SUMMARY
              echo "\`\`\`" | tee -a $GITHUB_STEP_SUMMARY
            fi
          done

      - name: Check Services
        run: |
          echo "## Service Status" | tee -a $GITHUB_STEP_SUMMARY

          echo "\`\`\`" | tee -a $GITHUB_STEP_SUMMARY
          kubectl get service -n ${NAMESPACE} | tee -a $GITHUB_STEP_SUMMARY
          echo "\`\`\`" | tee -a $GITHUB_STEP_SUMMARY

          if kubectl get service ${APP_NAME} -n ${NAMESPACE} &>/dev/null; then
            echo "### Service Details" | tee -a $GITHUB_STEP_SUMMARY
            echo "\`\`\`yaml" | tee -a $GITHUB_STEP_SUMMARY
            kubectl describe service ${APP_NAME} -n ${NAMESPACE} | tee -a $GITHUB_STEP_SUMMARY
            echo "\`\`\`" | tee -a $GITHUB_STEP_SUMMARY
          fi

      - name: Check Ingress
        run: |
          echo "## Ingress Status" | tee -a $GITHUB_STEP_SUMMARY

          echo "\`\`\`" | tee -a $GITHUB_STEP_SUMMARY
          kubectl get ingress -n ${NAMESPACE} | tee -a $GITHUB_STEP_SUMMARY
          echo "\`\`\`" | tee -a $GITHUB_STEP_SUMMARY

          if kubectl get ingress ${APP_NAME} -n ${NAMESPACE} &>/dev/null; then
            echo "### Ingress Details" | tee -a $GITHUB_STEP_SUMMARY
            echo "\`\`\`yaml" | tee -a $GITHUB_STEP_SUMMARY
            kubectl describe ingress ${APP_NAME} -n ${NAMESPACE} | tee -a $GITHUB_STEP_SUMMARY
            echo "\`\`\`" | tee -a $GITHUB_STEP_SUMMARY
          fi

      - name: Check Recent Events
        if: inputs.check_events == true
        run: |
          echo "## Recent Events" | tee -a $GITHUB_STEP_SUMMARY

          echo "\`\`\`" | tee -a $GITHUB_STEP_SUMMARY
          kubectl get events -n ${NAMESPACE} --sort-by='.lastTimestamp' | tail -30 | tee -a $GITHUB_STEP_SUMMARY
          echo "\`\`\`" | tee -a $GITHUB_STEP_SUMMARY

      - name: Check Secrets
        run: |
          echo "## Secrets Status" | tee -a $GITHUB_STEP_SUMMARY

          echo "\`\`\`" | tee -a $GITHUB_STEP_SUMMARY
          kubectl get secrets -n ${NAMESPACE} | tee -a $GITHUB_STEP_SUMMARY
          echo "\`\`\`" | tee -a $GITHUB_STEP_SUMMARY

          # Check if ECR pull secret exists
          if kubectl get secret ecr-pull-secret -n ${NAMESPACE} &>/dev/null; then
            echo "✅ ECR pull secret exists" | tee -a $GITHUB_STEP_SUMMARY

            # Check secret age
            SECRET_AGE=$(kubectl get secret ecr-pull-secret -n ${NAMESPACE} -o jsonpath='{.metadata.creationTimestamp}')
            echo "- Created: ${SECRET_AGE}" | tee -a $GITHUB_STEP_SUMMARY
            echo "⚠️ ECR tokens expire after 12 hours - refresh if needed" | tee -a $GITHUB_STEP_SUMMARY
          else
            echo "❌ ECR pull secret not found - run bootstrap workflow" | tee -a $GITHUB_STEP_SUMMARY
          fi

      - name: Check ConfigMaps
        run: |
          echo "## ConfigMaps" | tee -a $GITHUB_STEP_SUMMARY

          echo "\`\`\`" | tee -a $GITHUB_STEP_SUMMARY
          kubectl get configmaps -n ${NAMESPACE} | tee -a $GITHUB_STEP_SUMMARY
          echo "\`\`\`" | tee -a $GITHUB_STEP_SUMMARY

      - name: Health Check Test
        continue-on-error: true
        run: |
          echo "## Health Check Test" | tee -a $GITHUB_STEP_SUMMARY

          # Get first ready pod
          POD=$(kubectl get pod -n ${NAMESPACE} -l app=${APP_NAME} --field-selector=status.phase=Running -o jsonpath='{.items[0].metadata.name}' 2>/dev/null)

          if [ -n "$POD" ]; then
            echo "Testing health check on pod: $POD" | tee -a $GITHUB_STEP_SUMMARY

            # Port-forward for health check
            kubectl port-forward -n ${NAMESPACE} ${POD} 8081:8080 &
            PF_PID=$!
            sleep 3

            if wget -qO- http://localhost:8081/ > /dev/null 2>&1; then
              echo "✅ Health check passed" | tee -a $GITHUB_STEP_SUMMARY
            else
              echo "❌ Health check failed" | tee -a $GITHUB_STEP_SUMMARY
            fi

            kill $PF_PID 2>/dev/null || true
          else
            echo "⚠️ No running pods found for health check" | tee -a $GITHUB_STEP_SUMMARY
          fi

      - name: Generate Diagnostics Summary
        if: always()
        run: |
          echo "---" | tee -a $GITHUB_STEP_SUMMARY
          echo "## Troubleshooting Tips" | tee -a $GITHUB_STEP_SUMMARY
          echo "" | tee -a $GITHUB_STEP_SUMMARY
          echo "### Common Issues:" | tee -a $GITHUB_STEP_SUMMARY
          echo "" | tee -a $GITHUB_STEP_SUMMARY
          echo "1. **ImagePullBackOff**: Check ECR pull secret (expires after 12h)" | tee -a $GITHUB_STEP_SUMMARY
          echo "   - Run: \`gh workflow run ci-build-push-mall-maintenance-dev.yaml\`" | tee -a $GITHUB_STEP_SUMMARY
          echo "" | tee -a $GITHUB_STEP_SUMMARY
          echo "2. **CrashLoopBackOff**: Check pod logs above for application errors" | tee -a $GITHUB_STEP_SUMMARY
          echo "" | tee -a $GITHUB_STEP_SUMMARY
          echo "3. **ArgoCD Out of Sync**: Force sync ArgoCD application" | tee -a $GITHUB_STEP_SUMMARY
          echo "   - Visit: https://argocd-usw2.agent.opsera.dev" | tee -a $GITHUB_STEP_SUMMARY
          echo "" | tee -a $GITHUB_STEP_SUMMARY
          echo "4. **Ingress Not Working**: Check ingress controller is running" | tee -a $GITHUB_STEP_SUMMARY
          echo "" | tee -a $GITHUB_STEP_SUMMARY
          echo "---" | tee -a $GITHUB_STEP_SUMMARY
          echo "*Powered by Opsera Code-to-Cloud Enterprise v0.922*" | tee -a $GITHUB_STEP_SUMMARY
